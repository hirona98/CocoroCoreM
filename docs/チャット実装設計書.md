# チャットWebSocket API実装設計書

## 概要

CocoroCore2のWebSocketベースチャットAPI実装について、CocoroDockとの統合を考慮した詳細設計を記載します。現在はWebSocketのみをサポートし、SSE APIは完全に削除されています。

## 実装仕様

### 1. WebSocketチャットAPI実装 (`api/websocket_chat.py`)

**主要特徴** - CocoroMOSProduct統合、高度なバッファリング機能:

#### WebSocketChatManager クラス

**主要機能**:
- WebSocket接続の管理とセッション処理
- ThreadPoolExecutorによる非ブロッキング処理
- テキストバッファリングによる最適化された配信

```python
class WebSocketChatManager:
    """WebSocketチャット管理クラス"""
    
    def __init__(self):
        self.active_connections: Dict[str, WebSocket] = {}
        self.active_sessions: Dict[str, dict] = {}
        self.executor = ThreadPoolExecutor(max_workers=4, thread_name_prefix="MOSProduct")
    
    async def handle_message(self, client_id: str, message: dict, app):
        """WebSocketメッセージ処理メイン関数"""
        # 1. リクエスト検証
        # 2. コンテキスト統合
        # 3. 非同期セッション開始
        # 4. ストリーミング応答配信
```

#### 核心機能詳細

##### 1. テキストバッファリング機能
```python
async def _flush_text_buffer(self, session_info: dict, websocket: WebSocket, 
                           session_id: str, force: bool = False):
    """
    テキストバッファリング制御
    - 80文字閾値での句読点境界送信
    - 2秒タイムアウトでの強制送信
    - 日本語・英語対応の句読点検出
    """
```

##### 2. セッション管理機能
```python
async def _process_chat_stream(self, websocket: WebSocket, session_id: str, 
                              request_data: dict, app):
    """
    並行セッション処理の実装
    - 非ブロッキング処理によるマルチセッション対応
    - 適切なリソース管理とクリーンアップ
    """
```

##### 3. コンテキスト自動統合
```python
def _build_enhanced_query(self, request_data: dict) -> str:
    """
    chat_typeに応じたコンテキスト統合
    - notification: 【送信元からの通知】形式
    - desktop_watch: 【デスクトップ監視】形式
    - text_image: 画像枚数情報追加
    """
```

### 2. CocoroMOSProduct統合 (`core/cocoro_mos_product.py`)

**CocoroAI専用MOSProduct実装**:

```python
class CocoroMOSProduct(MOSProduct):
    """
    CocoroAI専用MOSProduct
    MemOSのMOSProductを継承し、CocoroAIのシステムプロンプト機能を統合
    """
    
    def __init__(self, system_prompt_provider: Optional[Callable] = None):
        super().__init__()
        self.system_prompt_provider = system_prompt_provider
    
    def _build_enhance_system_prompt(self, user_id: str, memories_all: List) -> str:
        """
        CocoroAI専用システムプロンプト構築
        - CocoroAIキャラクター設定からシステムプロンプト取得
        - MemOSの記憶情報と統合
        - PersonalMemoryとOuterMemoryの適切な分類
        """
```

### 3. CocoroProductWrapper統合 (`core/cocoro_product.py`)

**主要機能**:
- キューブ管理の自動化
- システムプロンプトファイルのUUID部分マッチング
- Neo4j Community Edition設定の自動生成
- MemOSライフサイクル管理

```python
class CocoroProductWrapper:
    """MOSProductのラッパークラス"""
    
    async def chat_with_references(self, query: str, cube_id: str, **kwargs):
        """
        完全自動記憶管理付きストリーミングチャット
        - ストリーミング終了シグナル検出での早期終了
        - 記憶保存処理の非ブロッキング化
        """
```

## 現在の実装状況

### 実装済み機能 ✅

1. **WebSocketチャットAPI**: 完全実装
2. **CocoroMOSProduct統合**: システムプロンプト統合実装済み
3. **テキストバッファリング**: 高度なUX最適化実装済み
4. **コンテキスト自動統合**: 通知・デスクトップ監視対応済み
5. **Neo4j統合**: Community Edition対応済み
6. **キューブ管理**: 自動作成・管理実装済み

### 実装予定機能 🚧

1. **Vision LLM画像分析**: `ImageAnalyzer`クラス実装予定
2. **高度な画像処理**: Vision APIとの完全統合
3. **画像理解機能**: text_imageチャットの完全対応

### アーキテクチャ特徴

- **非ブロッキング処理**: ThreadPoolExecutorによる並行処理
- **高度なバッファリング**: 句読点境界での最適配信
- **メモリ効率**: asyncio.Queueによる軽量通信
- **エラー回復**: 堅牢なエラーハンドリング機能
- **パフォーマンス最適化**: トークナイザー無効化による高速処理
